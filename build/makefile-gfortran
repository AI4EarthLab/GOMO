
# PETSC_INC=-I${PETSC_DIR}/include -I${PETSC_DIR}/${PETSC_ARCH}/include
# PETSC_LIB=-L${PETSC_DIR}/${PETSC_ARCH}/lib

SRCDIR           = ./src/
OBJDIR           = ./lib/
BINDIR           = ./bin/

EXT_LIB = -L${EXT_PATH}/lib64/
JIT_LIB = ${EXT_PATH}/lib64/

EXE              = pom2k
#FC	         = mpif90
#FLINKER          = mpif90 
FC	         = mpifort -O3
FLINKER          = mpifort -O3
CFLAGS	         =
FFLAGS	         =-Wno-tabs -I ${EXT_PATH}/include \
		  -J ${OBJDIR} -I ${OPEN_ARRAY} -g \
		 -fbacktrace -ffree-line-length-0 
CPPFLAGS         =
FPPFLAGS         =
CLEANFILES       = pom2k *.o *.mod *.nc
NP               = 1

OOO              = \
		print_section.o read_var.o \
		dens.o baropg.o bottom_friction.o lateral_bc.o \
		get_time.o advct.o advt2.o lateral_viscosity.o \
		advave.o bcond1.o smoth_update.o smol_adif.o\
		bcond2_ua.o bcond2_va.o external_el.o \
		external_ua.o external_va.o external_update.o \
		bcond3_u.o bcond3_v.o bcond4.o bcond6.o \
		internal_q.o adjust_uv.o adjust_ufvf.o \
		mode_interaction.o internal_t.o internal_u.o \
		internal_v.o internal_w.o \
		internal_update.o \
		surface_forcing.o update_initial.o \
		oa_kernels.o


#		bcond6.o smoth_update.o\

OBJ	= ${addprefix ${OBJDIR}/, config.o \
		variables.o dens.o read_init.o  \
		init_fields.o update_initial.o \
		bottom_friction.o get_time.o \
		read_var.o surface_forcing.o \
		lateral_bc.o advct.o baropg.o \
		lateral_viscosity.o advave.o \
		mode_interaction.o bcond1.o \
		external_el.o bcond2_ua.o \
		external_ua.o external_va.o \
		bcond2_va.o external_update.o \
		adjust_uv.o internal_w.o\
		internal_q.o internal_update.o \
		bcond6.o smoth_update.o \
		advt2.o bcond4.o internal_t.o \
		smol_adif.o bcond3_u.o bcond3_v.o \
		internal_u.o internal_v.o \
		adjust_ufvf.o pom2k.o}

OBJMAIN	= ${OBJ}

.DEFAULT_GOAL := all

all :
	@./fypp1 -p  -m re -m string -m io -m os --create-parents \
	src/oa_kernels.fypp src/oa_kernels.F90
	@make main


${OBJDIR}/%.o: ${SRCDIR}/%.F90
	-${FC} ${FFLAGS} -c -o $@ $<


%.o: %.mod

main : ${OBJ}
	-${FLINKER} -o ${BINDIR}/pom2k ${OBJ} \
	${EXT_LIB} -I ${OPEN_ARRAY} -L${OPEN_ARRAY} \
	-lopenarray -lm -ldl -lstdc++ \
	-lboost_program_options -lboost_system -ljit  -lpnetcdf

run : main
	-cd ./bin && ./pom2k

run4 : main
	-cd ./bin && mpirun -np 4 ./pom2k -s 100

run2 : main
	-cd ./bin && mpirun -np 2 ./pom2k
oalib :
	-cd ../../OpenArray/ && make oalib
clean ::
	-rm lib/*.o
	-rm bin/${EXE}

check :
	-echo ${OBJ}
	-echo ${DM}

