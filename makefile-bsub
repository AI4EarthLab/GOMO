
SRCDIR           = ./src/
OBJDIR           = ./lib/
BINDIR           = ./bin/

EXE              = pom2k
FC	         = 
FLINKER          = 
CFLAGS	         =
FFLAGS	         = -I ${PNETCDF}/include -I ${OPEN_ARRAY} 
CPPFLAGS         =
FPPFLAGS         =
CLEANFILES       = pom2k *.o *.mod *.nc
NP               = 1

OBJ		 = ${addprefix ${OBJDIR}/, \
		input.o variables.o init_fields.o \
		print_section.o read_var.o \
		dens.o baropg.o bottom_friction.o lateral_bc.o \
		get_time.o advct.o advt2.o lateral_viscosity.o \
		advave.o bcond1.o smoth_update.o smol_adif.o\
		bcond2_ua.o bcond2_va.o external_el.o \
		external_ua.o external_va.o external_update.o \
		bcond3_u.o bcond3_v.o bcond4.o bcond6.o \
		internal_q.o adjust_uv.o adjust_ufvf.o \
		mode_interaction.o internal_t.o internal_u.o \
		internal_v.o internal_w.o \
		internal_update.o \
		surface_forcing.o update_initial.o \
		read_init.o pom2k.o}

OBJMAIN	= ${OBJ}

include ${PETSC_DIR}/lib/petsc/conf/variables
include ${PETSC_DIR}/lib/petsc/conf/rules

${OBJDIR}/%.o: ${SRCDIR}/%.F90
	-${FC} ${FFLAGS} -c -o $@ $<

.DEFAULT_GOAL := main
main : ${OBJ}
	-${FLINKER}  ${OBJ} ${PETSC_KSP_LIB} -I ${OPEN_ARRAY} -L ${OPEN_ARRAY} -lopenarray ${PNETCDF}/lib/libpnetcdf.a -o ${BINDIR}/pom2k 

run : main
	-cd ./bin && ./pom2k

run4 : main
	-cd ./bin && bsub -I -q q_x86_cn_cess -np 4 ./pom2k

run2 : main
	-cd ./bin && mpirun -np 2 ./pom2k
oalib :
	-cd ../../OpenArray/ && make oalib
clean ::
	-rm lib/*.o
	-rm bin/${EXE}

check :
	-echo ${OBJ}
	-echo ${DM}

